#+TITLE: My Emacs Config.
#+AUTHOR: Angel Dhakal (xynapz@github.com).
#+DESCRIPTION: The road to Emacs bankruptcy starts here.

* GC Optimization
#+begin_src elisp
(defun restore-gc-cons-threshold ()
  (setq gc-cons-threshold 64000000
        gc-cons-percentage 0.1))

(setq gc-cons-threshold most-positive-fixnum
      gc-cons-percentage 0.6)

(add-hook 'emacs-startup-hook #'restore-gc-cons-threshold 105)
#+end_src

* Packages
** Setting up package archieve
#+begin_src elisp
  (require 'package)
  (setq package-archives '(("melpa" . "https://melpa.org/packages/")
  			 ("nongnu" . "https://elpa.nongnu.org/nongnu/")
  			 ("elpa" . "https://elpa.gnu.org/packages/")))
  (package-initialize)
  (unless package-archive-contents
    (package-refresh-contents))
  (unless (package-installed-p 'use-package)
    (package-install 'use-package))
  (require 'use-package)
  (setq use-package-always-ensure t)
#+end_src
* UI

** Transparency
#+begin_src elisp
(add-to-list 'default-frame-alist '(alpha-background . 100))
#+end_src

** Cursor
#+begin_src elisp
(setq-default cursor-type 'bar)   ;; options: 'bar, 'box, 'hollow, 'hbar, or nil
#+end_src

** Display and Toolbars
#+begin_src elisp
  (setq visible-bell nil)
  (use-package scroll-bar
    :ensure nil
    :config
    (scroll-bar-mode -1))

  (use-package tool-bar
    :ensure nil
    :config
    (tool-bar-mode -1))

  (use-package menu-bar
    :ensure nil
    :config
    (menu-bar-mode -1))
#+end_src

** Window Property
#+begin_src elisp
(setopt frame-title-format "Angel")
(add-to-list 'default-frame-alist '(undecorated . t))
#+end_src

** Lines
#+begin_src elisp
  (global-visual-line-mode 1)

(use-package hl-line
  :config
  (global-hl-line-mode 1)
  ;; Disable hl-line in interactive shells
  (dolist (hook '(comint-mode-hook eshell-mode-hook))
    (add-hook hook (lambda () (setq-local global-hl-line-mode nil)))))

;; Better display-line-numbers configuration
(use-package display-line-numbers
  :init
  ;; Set global default line number type (can be t, 'relative, or 'visual)
  (setq-default display-line-numbers-type 't)
  :config
  ;; Enable line numbers in programming and config modes
  (dolist (hook '(prog-mode-hook conf-mode-hook nxml-mode-hook text-mode-hook))
    (add-hook hook #'display-line-numbers-mode))
  ;; Disable line numbers in certain modes (optional)
  (dolist (hook '(eshell-mode-hook term-mode-hook vterm-mode-hook shell-mode-hook))
    (add-hook hook (lambda () (display-line-numbers-mode 0)))))
#+end_src

** Startup Buffer
#+begin_src elisp
(setopt initial-scratch-message nil
        inhibit-startup-screen t)
#+end_src

** Mode Line
#+begin_src elisp
(defun my/setup-mode-line ()
  "Set up a clean purple mode line."
  (set-face-attribute 'mode-line nil
                      :background "#7e57c2"   ;; Purple background
                      :foreground "#ffffff"   ;; White text
                      :box nil
                      :height 1.0
                      :overline nil
                      :underline nil)

  (set-face-attribute 'mode-line-inactive nil
                      :background "#4a148c"   ;; Darker purple for inactive windows
                      :foreground "#cccccc"
                      :box nil
                      :height 1.0
                      :overline nil
                      :underline nil))

(add-hook 'after-init-hook #'my/setup-mode-line)
#+end_src

** Fonts
#+begin_src elisp
  (defvar my/font-primary "JetBrains Mono"
    "Primary monospace font for code buffers.")

  (defvar my/font-variable "Iosevka Aile"
    "Variable-pitch font for prose, markdown, and Org buffers.")

  (defvar my/font-symbol "Noto Color Emoji"
    "Fallback font for symbols and emojis.")

  (defvar my/font-size 15
    "Default font size for Emacs frames.")

  (set-face-attribute 'default nil :font "JetBrainsMono Nerd Font" :height 134)
#+end_src

** Theme
#+begin_src elisp
(load-theme 'modus-vivendi t)
#+end_src

* Files

** Encoding
#+begin_src elisp
  (setopt buffer-file-coding-system 'utf-8-unix)
#+end_src

** Dired
#+begin_src elisp
  (use-package dired
    :ensure nil
    :commands dired
    :hook
    (dired-mode . dired-hide-details-mode)
    :custom
    (dired-listing-switches "-Ahl --group-directories-first")
    (dired-kill-when-opening-new-dired-buffer t)
    (dired-dwim-target t))
#+end_src

** Dired Colors
#+begin_src elisp
(use-package diredfl
  :after dired
  :config
  (diredfl-global-mode 1))
#+end_src

** Disabling backups and autosaves.
#+begin_src emacs-lisp
  (setq
   make-backup-files nil
   auto-save-default nil
   create-lockfiles nil)
#+end_src

* Text/Code

** Smart Parenthesis auto
#+begin_src elisp
  (use-package smartparens
    :ensure smartparens
    :hook (prog-mode text-mode markdown-mode)
    :config
    ;; load default config
    (require 'smartparens-config))
#+end_src

** Rainbow parenthesis
#+begin_src elisp
  (use-package rainbow-delimiters
    :disabled
    :hook ((prog-mode . rainbow-delimiters-mode)))
#+end_src


* Minibuffer

** Vertico
Provides a fast, vertical UI for minibuffer completion
#+begin_src elisp
  (use-package vertico
    :init
    (vertico-mode)
    :config
    (setq vertico-cycle t
          vertico-resize t))
#+end_src

** Orderless
Enables flexible pattern matching for completions minibuffer completions
#+begin_src elisp
  (use-package orderless
    :config
    (setq completion-styles '(orderless basic)
          completion-category-defaults nil
          completion-category-overrides '((file (styles partial-completion)))))
#+end_src

** Marginilia
Adds helpful annotations to minibuffer completions. Enhances completion candidates with metadata (e.g., file size, buffer major mode, etc.)
#+begin_src elisp
  (use-package marginalia
    :init
    (marginalia-mode))
#+end_src

* Project, LSP and Completion
** Projects Setup
#+begin_src elisp
  (use-package projectile
    :ensure t
    :demand t
    :init
    (projectile-mode +1)
    :config
    (projectile-global-mode)
    (setq projectile-enable-caching t)
    (setq projectile-completion-system 'default)
    (setq projectile-indexing-method 'alien)
    (setq projectile-ignored-projects '("/home/angel/xynapz/byte-arena"))
    (setq projectile-globally-ignored-directories
          (append '("build" "dist" ".venv" "venv" "node_modules")
                  projectile-globally-ignored-directories))
    (when (executable-find "fd")
      (setq projectile-generic-command "fd -t f -0")))
#+end_src

** eglot lsp
#+begin_src elisp
  (use-package eglot
    :ensure nil
    :hook ((c-mode c++-mode python-mode) . eglot-ensure)
    :bind (:map eglot-mode-map
                ("C-c r" . eglot-rename)
                ("C-c a" . eglot-code-actions)
                ("C-c d" . xref-find-definitions)
                ("C-c b" . xref-pop-marker-stack))
    :custom
    (eglot-events-buffer-size 0)
    (eglot-sync-connect nil))
#+end_src

** Company In-buffer Completion
#+begin_src elisp
  (use-package company
    :ensure t
    :hook (after-init . global-company-mode)
    :bind (:map company-active-map
                ("C-n" . company-select-next)
                ("C-p" . company-select-previous)
                ("RET" . company-complete-selection))
    :custom
    (company-idle-delay 0.2)
    (company-minimum-prefix-length 2)
    (company-tooltip-align-annotations t)
    (company-selection-wrap-around t))
#+end_src

** Flycheck Syntax Highlight
#+begin_src elisp
  ;; flycheck for syntax checking
  (use-package flycheck
    :ensure t
    :config
    (global-flycheck-mode)
    (setq flycheck-indication-mode 'right-fringe)
    (setq flycheck-emacs-lisp-load-path 'inherit))

  (defun my/flymake-toggle-diagnostics-buffer ()
    (interactive)
    ;; Check if we are in the diagnostics buffer.
    (if (string-search "*Flymake diagnostics" (buffer-name))
        (delete-window)
      (progn
        ;; Activate the Flymake diagnostics buffer.
        ;; and switch to it
        (flymake-show-buffer-diagnostics)
        (let ((name (flymake--diagnostics-buffer-name)))
    	(if (get-buffer name)
              (switch-to-buffer-other-window name)
            (error "No Flymake diagnostics buffer found")
            )))))

  (global-set-key [(f4)] #'my/flymake-toggle-diagnostics-buffer)
  ;; Additional bindings.
  (global-set-key (kbd "C-c f b") #'flymake-show-buffer-diagnostics)
  (global-set-key (kbd "C-c f p") #'flymake-show-project-diagnostics)
#+end_src

* C++ Development

** C++ Mode Configuration
#+begin_src elisp
  ;; Ensure files end with newline (Google C++ standard)
  (setq require-final-newline t
        mode-require-final-newline t)

  (add-hook 'c-mode-hook 'eglot-ensure)
  (add-hook 'c++-mode-hook 'eglot-ensure)
  (add-hook 'c-or-c++-mode-hook 'eglot-ensure)

  ;; .h files to open in c++-mode rather than c-mode.
  (add-to-list 'auto-mode-alist '("\\.h$" . c++-mode))

  ;; google code style
  (add-hook 'c-mode-common-hook
            (lambda ()
              (c-set-style "google")
              (setq c-basic-offset 2)))

  ;; emacs-fu: donâ€™t indent inside of C++ namespaces
  ;; http://brrian.tumblr.com/post/9018043954/emacs-fu-dont-indent-inside-of-c-namespaces
  (c-set-offset 'innamespace 0)

  ;; Spaces instead of tabs when indenting.
  (setq-default indent-tabs-mode nil)
#+end_src

** Whitespace Cleanup
#+begin_src elisp
  (use-package whitespace
    :config
    ;; Commented since there are too many 'valid' whitespaces in some modes.
    ;; (setq-default show-trailing-whitespace t)
    (setq whitespace-style '(face tabs trailing))
    (set-face-attribute 'whitespace-tab nil
  		      :weight 'bold)
    (add-hook 'prog-mode-hook 'whitespace-mode)
    ;; Delete trailing tabs and spaces on save of a file.
    (add-hook 'before-save-hook 'whitespace-cleanup))
#+end_src

** CMake Support
#+begin_src elisp
  (use-package cmake-mode
    :mode (("CMakeLists\\.txt\\'" . cmake-mode)
           ("\\.cmake\\'" . cmake-mode)))
#+end_src

** Modern C++ Font Lock
#+begin_src elisp
  (use-package modern-cpp-font-lock
    :hook (c++-mode . modern-c++-font-lock-mode))
#+end_src

** Compilation
#+begin_src elisp
  (use-package compile
    :ensure nil
    :custom
    (compilation-scroll-output t)
    (compilation-ask-about-save nil)
    :config
    (setq compilation-environment '("TERM=xterm-256color"))
    :hook
    (compilation-filter . (lambda ()
                           (ansi-color-apply-on-region
                            compilation-filter-start (point)))))
#+end_src

** Commenting - Works for All Languages
#+begin_src elisp
  ;; Smart commenting that works in any mode
  (global-set-key (kbd "C-c c") 'comment-line)        ; Comment/uncomment current line
  (global-set-key (kbd "C-c C-/") 'comment-or-uncomment-region)  ; Comment/uncomment region
  (global-set-key (kbd "M-;") 'comment-dwim)          ; Do-what-I-mean commenting

  ;; Auto-fill comments at 80 characters
  (setq-default comment-auto-fill-only-comments t)
  (add-hook 'prog-mode-hook
            (lambda ()
              (setq fill-column 80)
              (auto-fill-mode 1)))
#+end_src

** CMake Build Integration
#+begin_src elisp
  (defun my/cmake-configure ()
    "Run cmake .. from build directory and create symlink for compile_commands.json."
    (interactive)
    (let* ((project-root (project-root (project-current t)))
           (build-dir (file-name-as-directory (concat project-root "build")))
           (default-directory build-dir)
           (compile-commands-src (concat build-dir "compile_commands.json"))
           (compile-commands-dest (concat project-root "compile_commands.json")))
      (unless (file-exists-p build-dir)
        (make-directory build-dir t))
      (compile "cmake ..")
      ;; Create symlink after cmake runs
      (run-with-timer 2 nil
                      (lambda ()
                        (when (file-exists-p compile-commands-src)
                          (when (file-exists-p compile-commands-dest)
                            (delete-file compile-commands-dest))
                          (make-symbolic-link compile-commands-src compile-commands-dest t)
                          (message "Created symlink: compile_commands.json -> build/"))))))

  (defun my/cmake-build ()
    "Compile the project using make in build directory."
    (interactive)
    (let* ((project-root (project-root (project-current t)))
           (build-dir (file-name-as-directory (concat project-root "build")))
           (default-directory build-dir))
      (compile "make")))

  (defun my/cmake-run ()
    "Run the compiled executable in an interactive comint buffer."
    (interactive)
    (let* ((project-root (project-root (project-current t)))
           (build-dir (file-name-as-directory (concat project-root "build")))
           (default-directory build-dir)
           (executables (directory-files build-dir nil "^[^.].*[^.o]$"))
           (exe (if (= (length executables) 1)
                    (car executables)
                  (completing-read "Run executable: " executables)))
           (buffer-name (format "*run: %s*" exe)))
      (let ((buf (get-buffer-create buffer-name)))
        (with-current-buffer buf
          (comint-mode)
          (setq-local comint-process-echoes nil)
          (erase-buffer))
        (make-comint-in-buffer exe buf (concat "./" exe))
        (pop-to-buffer buf))))

  (global-set-key (kbd "<f5>") 'my/cmake-configure)  ; cmake -G Ninja .. + symlink
  (global-set-key (kbd "<f6>") 'my/cmake-build)      ; ninja
  (global-set-key (kbd "<f7>") 'my/cmake-run)        ; run executable (interactive)
  (global-set-key (kbd "<f8>") 'recompile)           ; recompile on error
#+end_src

** File Sidebar - Treemacs
#+begin_src elisp
  (use-package treemacs
    :ensure t
    :bind (("<f9>" . treemacs)
           ("C-x p t" . my/treemacs-switch-project))
    :config
    (setq treemacs-width 30
          treemacs-follow-mode t
          treemacs-filewatch-mode t
          treemacs-fringe-indicator-mode 'always)
    (defun my/treemacs-switch-project ()
      "Switch treemacs to current project root."
      (interactive)
      (when-let ((project (project-current)))
        (treemacs-add-and-display-current-project-exclusively))))

  (use-package treemacs-projectile
    :after (treemacs projectile))

  (global-set-key [(f10)] #'treemacs-select-window)

  (use-package nerd-icons-dired
    :hook
    (dired-mode . nerd-icons-dired-mode)
    :after dired)
#+end_src

