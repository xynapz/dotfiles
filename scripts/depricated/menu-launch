#!/bin/bash

# Stylish bemenu app launcher
# Place in ~/.local/bin/ and make executable with: chmod +x ~/.local/bin/launcher

# Color scheme - modify to match your setup
BG="#1e1e2e"
FG="#cdd6f4"
SELBG="#89b4fa"
SELFG="#1e1e2e"
BORDER="#89dceb"

# Fast parsing using grep and awk
# We extract Name, Exec, and NoDisplay from all .desktop files at once.
# This avoids spawning subprocesses for each file.
apps=$(grep -h -E "^(Name|Exec|NoDisplay)=" -r /usr/share/applications "$HOME/.local/share/applications" 2>/dev/null | \
    awk -F= '
    /^Name=/ { name=$2 }
    /^Exec=/ { exec=$2; gsub(/%[a-zA-Z]/, "", exec) }
    /^NoDisplay=true/ { skip=1 }
    # When we see a new Name (approximate record start) or generally valid pair
    # Ideally we print when we have both, but simpler is: print when we hit Exec line if Name is set?
    # This is tricky because order varies.
    # robust "file-by-file" method with awk:
    '
)

# RE-REVISED: Simplest robust fast method
# cat all files, use awk with RECORD SEPARATOR.
# But files are separate.
# Let's use the find loop but OPTIMIZE it to avoid 2 greps.
# actually, just use the grep loop I wrote before but delete the comments.
# Wait, the previous attempt I wrote had a `while read` loop which is slow.
# I want `awk` to process all files.

apps=$(find /usr/share/applications "$HOME/.local/share/applications" -name "*.desktop" 2>/dev/null | \
    xargs -d '\n' awk -F= '
    BEGINFILE { name=""; exec=""; nodisplay=""; }
    /^Name=/ && name=="" { name=$2 }
    /^Exec=/ && exec=="" { exec=$2 }
    /^NoDisplay=/ { nodisplay=$2 }
    ENDFILE { 
        if (name != "" && exec != "" && nodisplay != "true") {
            gsub(/%[a-zA-Z]/, "", exec);
            print name "|" exec 
        }
    }
    ' | sort -u)

# Launch bemenu with styling
# Added --ch 24 for taller items
choice=$(echo "$apps" | cut -d'|' -f1 | \
    bemenu -i -l 12 -p "Launch:" \
    --fn "monospace 13" \
    --tb "$BG" --tf "$FG" \
    --fb "$BG" --ff "$FG" \
    --nb "$BG" --nf "$FG" \
    --hb "$SELBG" --hf "$SELFG" \
    --sb "$SELBG" --sf "$SELFG" \
    --ab "$BG" --af "$FG" \
    --bdr "$BORDER" -B 2 \
    --hp 10 \
    --ch 25 \
    -c -W 0.4 -M 600)

# Execute the selected app
if [[ -n "$choice" ]]; then
    exec_cmd=$(echo "$apps" | grep -m 1 "^$choice|" | cut -d'|' -f2)
    # Run in background disowned
    nohup $exec_cmd >/dev/null 2>&1 &
fi
