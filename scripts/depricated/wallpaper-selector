#!/bin/bash

# Configuration
WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/wallpaper-selector"

# Ensure directories exist
mkdir -p "$CACHE_DIR"

# Detect Session
SESSION_TYPE=""
if [ "$XDG_SESSION_TYPE" == "wayland" ]; then
    SESSION_TYPE="wayland"
elif [ -n "$DISPLAY" ]; then
    SESSION_TYPE="x11"
fi

# Helper: Run launcher (Wayland: fuzzel, X11: dmenu)
run_launcher() {
    if [ "$SESSION_TYPE" == "wayland" ]; then
        fuzzel --dmenu --prompt "Set Wallpaper: "
    else
        # X11 dmenu (simple fallback)
        dmenu -i -l 15 -p "Set Wallpaper:"
    fi
}

set_wallpaper() {
    local file="$1"
    
    if [ "$SESSION_TYPE" == "wayland" ]; then
        # Use Sway's native output background command
        swaymsg output "*" bg "$file" fill
    else
        # X11 Fallback requires feh, nitrogen, or xwallpaper
        if command -v feh >/dev/null 2>&1; then
            feh --bg-fill "$file"
        elif command -v xwallpaper >/dev/null 2>&1; then
            xwallpaper --zoom "$file"
        elif command -v nitrogen >/dev/null 2>&1; then
            nitrogen --set-zoom-fill "$file" --save
        else
            notify-send "Wallpaper Selector" "No X11 wallpaper setter found (install feh, xwallpaper, or nitrogen)."
            return
        fi
    fi

    # Create a symlink to the current wallpaper
    ln -sf "$file" "$HOME/.cache/current_wallpaper.jpg"
    notify-send "Wallpaper Changed" "$(basename "$file")" -i "$file"
}

# Main Logic
if [ -z "$1" ]; then
    cd "$WALLPAPER_DIR" || exit 1
    
    selected=$(find . -maxdepth 1 -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.gif" -o -name "*.webp" \) -printf "%f\n" | sort | run_launcher)

    if [ -n "$selected" ]; then
        FULL_PATH="$WALLPAPER_DIR/$selected"
        if [ -f "$FULL_PATH" ]; then
            set_wallpaper "$FULL_PATH"
        fi
    fi
else
    SELECTED_FILE="$1"
    if [ -f "$SELECTED_FILE" ]; then
        set_wallpaper "$SELECTED_FILE"
    elif [ -f "$WALLPAPER_DIR/$1" ]; then
        set_wallpaper "$WALLPAPER_DIR/$1"
    fi
fi
