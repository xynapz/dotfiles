#!/bin/bash

LOCK_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/gamemode.active"
HYPRFILE="$HOME/dotfiles/.config/hypr/hyprland.conf"

SESSION_TYPE=""
if [ "$XDG_SESSION_TYPE" == "wayland" ]; then
    SESSION_TYPE="wayland"
elif [ -n "$DISPLAY" ]; then
    SESSION_TYPE="x11"
fi

run_launcher() {
    local prompt="$1"
    if [ "$SESSION_TYPE" == "wayland" ]; then
        local BG="#1e1e2e"
        local FG="#cdd6f4"
        local SELBG="#89b4fa"
        local SELFG="#1e1e2e"
        local BORDER="#89dceb"

        bemenu -i -l 12 -p "$prompt" \
            --fn "monospace 13" \
            --tb "$BG" --tf "$FG" \
            --fb "$BG" --ff "$FG" \
            --nb "$BG" --nf "$FG" \
            --hb "$SELBG" --hf "$SELFG" \
            --sb "$SELBG" --sf "$SELFG" \
            --ab "$BG" --af "$FG" \
            --bdr "$BORDER" -B 2 \
            --hp 10 \
            --ch 25 \
            -c -W 0.4 -M 600
    else
        dmenu -i -l 15 -p "$prompt"
    fi
}

toggle_hyprland_gamemode() {
    local state="$1"
    
    if [ "$state" == "enable" ]; then
        touch "$LOCK_FILE"
        
        sed -i "s/monitors.conf/game\/monitor.conf/" "$HYPRFILE"
        sed -i "s/general.conf/game\/general.conf/" "$HYPRFILE"
        
        hyprctl --batch "\
            keyword animations:enabled 0;\
            keyword decoration:shadow:enabled 0;\
            keyword decoration:blur:enabled 0;\
            keyword general:gaps_in 0;\
            keyword general:gaps_out 0;\
            keyword decoration:rounding 0" > /dev/null

        notify-send -u low -t 2000 "Game Mode" "Enabled: Performance Mode Active"
    else
        rm -f "$LOCK_FILE"

        sed -i "s/game\/monitor.conf/monitors.conf/" "$HYPRFILE"
        sed -i "s/game\/general.conf/general.conf/" "$HYPRFILE"
        
        hyprctl reload > /dev/null

        notify-send -u low -t 2000 "Game Mode" "Disabled: Normal Mode Restored"
    fi
}

toggle_generic_gamemode() {
    local state="$1"
    if [ "$state" == "enable" ]; then
        touch "$LOCK_FILE"
        notify-send "Game Mode" "Enabled (Generic/X11)"
    else
        rm -f "$LOCK_FILE"
        notify-send "Game Mode" "Disabled (Generic/X11)"
    fi
}


if [ -f "$LOCK_FILE" ]; then
    STATUS="Disable Game Mode"
else
    STATUS="Enable Game Mode"
fi

CHOICE=$(echo "$STATUS" | run_launcher "Game Mode:")

if [ -n "$CHOICE" ]; then
    ACTION=""
    if [ "$CHOICE" == "Enable Game Mode" ]; then
        ACTION="enable"
    elif [ "$CHOICE" == "Disable Game Mode" ]; then
        ACTION="disable"
    fi

    if [ -n "$ACTION" ]; then
        if [ "$SESSION_TYPE" == "wayland" ] && [ -n "$HYPRLAND_INSTANCE_SIGNATURE" ]; then
            toggle_hyprland_gamemode "$ACTION"
        else
            toggle_generic_gamemode "$ACTION"
        fi
    fi
fi
