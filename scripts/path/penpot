#!/bin/bash

INSTALL_DIR="$HOME/.local/share/penpot"
DATA_DIR="$INSTALL_DIR/data"
CONFIG_DIR="$INSTALL_DIR/config"
COMPOSE_FILE="$CONFIG_DIR/docker-compose.yml"
ENV_FILE="$CONFIG_DIR/.env"
DESKTOP_FILE="$HOME/.local/share/applications/penpot.desktop"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
print_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
print_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
print_error() { echo -e "${RED}[ERROR]${NC} $1"; }

check_deps() {
    print_info "Checking for dependencies"
    local missing_deps=()
    command -v docker &> /dev/null || missing_deps+=("docker")

    if [ ${#missing_deps[@]} -ne 0 ]; then
        print_error "Missing dependencies: ${missing_deps[*]}"
        print_info "install package: docker"
    fi

    if ! systemctl is-active --quiet docker; then
        print_warning "docker.service is not running"
        print_info "starting docker.service"
        sudo systemctl start docker
        sudo systemctl enable docker
    fi

    if ! groups | grep -q docker; then
        print_warning "$USER not in docker group"
        print_info "adding user $USER to the docker group"
        sudo usermod -aG docker $USER
        print_warning "logout and log back in for the changes to take effect"
    fi
    print_success "deps statisfied"
}

setup_directories() {
    print_info "setting up directories"
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$DATA_DIR"
    mkdir -p "$HOME/.local/share/applications"
    print_success "directories created"
}

setup_env() {
    print_info "setting up .env for penpot"
    if [ ! -f "$HOME/dotfiles/.config/penpot/.env" ]; then
        print_error "penpot .env file not found."
        print_warning "make sure it exists at $HOME/dotfiles/.config/"
        exit 1
    else
        print_info "Copying penpot .env"
        cp "$HOME/dotfiles/.config/penpot/.env" "$ENV_FILE"
    fi
    print_success "PenPot Environment Variables Set"
}

setup_compose() {
    print_info "Setting up docker compose for penpot"
    if ! command -v docker &> /dev/null; then
        print_error "docker compose command not found"
        print_info "install docker-compose first then continue"
        exit 1
    else
        print_info "copying docker-compose.yml"
        cp "$HOME/dotfiles/.config/penpot/docker-compose.yml" "$COMPOSE_FILE"
    fi
    print_success "PenPot Docker Compose Setup"
}

setup_desktop_entry() {
    print_info "Setting up desktop entry"
    cat > "$DESKTOP_FILE" <<EOF
[Desktop Entry]
Version=2.11.1
Type=Application
Name=Penpot
Comment=Open-Source Design & Prototype Platform
Exec=xdg-open http://localhost:9001
Icon=applications-graphics
Terminal=false
Categories:Graphics;Design;
Keywords=design;prototype;ui;ux;figma;graphics
EOF
    chmod +x "$DESKTOP_FILE"
    update-desktop-database "$HOME/.local/share/applications/" 2> /dev/null || true
    print_success "Desktop Entry Created"
}

install() {
    print_info "Installing Penpot & Setting Up Configurations"
    check_deps || exit 1
    setup_directories
    setup_env
    setup_compose
    setup_desktop_entry
    print_success "Installation Complete!"
    print_info "start penpot with: $0 start"
}

start() {
    if [ ! -f "$COMPOSE_FILE" ];then
        print_error "docker-compose.yml file not found"
        exit 1
    fi

    print_info "Starting penpot"
    cd "$CONFIG_DIR"
    export DATA_DIR
    export ENV_FILE
    docker compose up -d
    print_success "penpot containers started"
    print_info "waiting for services to be ready (this may take 30-60 seconds)..."

    # Wait for frontend container
    local max_wait=60
    local elapsed=0

    while [ $elapsed -lt $max_wait ]; do
        if docker ps | grep -q penpot-frontend; then
            # Check if port 9001 is actually responding
            if curl -s http://localhost:9001 > /dev/null 2>&1; then
                print_success "penpot is ready!"
                print_info "Access it at: http://localhost:9001"
                print_info "Opening in browser"
                sleep 2
                xdg-open http://localhost:9001 &> /dev/null &
                return 0
            fi
        fi
        sleep 2
        elapsed=$((elapsed + 2))
        echo -n "."
    done

    echo ""
    print_warning "Penpot is starting but not yet responding"
    print_info "This is normal on first run - give it 1-2 more minutes"
    print_info "Check status with: $0 logs"
    print_info "Or try opening manually: xdg-open http://localhost:9001"
}

stop() {
    print_info "Stopping penpot"
    cd "$CONFIG_DIR"
    export DATA_DIR
    export ENV_FILE
    docker compose down
    print_success "Penpot stopped"
}

restart() {
    stop
    sleep 3
    start
}

status() {
    print_info "Penpot Service Status:"
    cd "$CONFIG_DIR"
    export DATA_DIR
    export ENV_FILE
    docker compose ps
}

logs() {
    cd "$CONFIG_DIR"
    export DATA_DIR
    export ENV_FILE
    if [ -n "$1" ]; then
        docker compose logs -f "$1"
    else
        docker compose logs -f
    fi
}

update() {
    print_info "Updating Penpot"
    cd "$CONFIG_DIR"
    export DATA_DIR
    export ENV_FILE
    docker-compose pull
    docker-compose up -d
    print_success "Penpot updated successfully."
}

show_usage() {
    cat <<EOF
Penpot Self-Hosted Manager

Usage: $0 <command>

Commands:
    install     Install and configure Penpot
    start       Start Penpot services
    stop        Stop Penpot services
    restart     Restart Penpot services
    status      Show service status
    logs        Show logs (add service name for specific logs)
    wait        Wait for the services to get ready for 120 seconds
    update      Update Penpot to latest version
    backup      Create a backup of data and configuration
    restore     Restore from backup file
    open        Open Penpot in browser
    uninstall   Remove Penpot completely
    help        Show this help message

Examples:
    $0 install
    $0 start
    $0 logs penpot-backend
    $0 backup
    $0 restore ~/penpot-backups/penpot_backup_20240101_120000.tar.gz

Configuration files:
    Install directory: $INSTALL_DIR
    Docker Compose: $COMPOSE_FILE
    Environment: $ENV_FILE
    Data directory: $DATA_DIR

EOF
}

wait_ready() {
    print_info "Waiting for Penpot to be ready..."
    local max_wait=120
    local elapsed=0

    while [ $elapsed -lt $max_wait ]; do
        if curl -s http://localhost:9001 > /dev/null 2>&1; then
            echo ""
            print_success "Penpot is ready!"
            print_info "Access it at: http://localhost:9001"
            return 0
        fi
        sleep 2
        elapsed=$((elapsed + 2))
        echo -n ". "
    done

    echo ""
    print_error "Penpot didn't respond within $max_wait seconds"
    print_info "Check logs with: $0 logs"
}

backup() {
    print_info "Starting Penpot Backup"
    local backup_dir = "$HOME/backups"
    mkdir -p "$backup_dir"

    local timestamp=$(date +"%Y%m%d-%H%M%S")
    local backup_file="$backup_dir/penpot-backip-$timestamp.tar.gz"
    print_info "creating backup"

    stop

    tar -czf "$backup_file" -C "$INSTALL_DIR" data config

    start
    print_success "Backup created: $backup_file"
}

restore() {
    # pause: need quite a lot more familiarity with tar utility
    echo "next iteration"
}

open_browser() {
    xdg-open http://localhost:9001 &> /dev/null &
    print_success "Opening Penpot in browser"
}

case "$1" in
    install)
        install
        ;;
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        restart
        ;;
    status)
        status
        ;;
    logs)
        logs "$2"
        ;;
    update)
        update
        ;;
    backup)
        backup
        ;;
    restore)
        restore "$2"
        ;;
    open)
        open_browser
        ;;
    uninstall)
        uninstall
        ;;
    help|--help|-h|h)
        show_usage
        ;;
    *)
        print_error "Unknown command"
        echo ""
        show_usage
        exit 1
        ;;
esac

