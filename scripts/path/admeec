#!/usr/bin/env bash
# admeec - AngeldMe Emacs Export Content
# Triggers Emacs to export site content to HTML.
# Intended for Hyprland keybinding.

set -euo pipefail

LOG_FILE="$HOME/xynapz/angeld/logs/site-export.log"
SCRIPT_EL="$HOME/dotfiles/scripts/workers/angeld-content-exporter.el"

mkdir -p "$(dirname "$LOG_FILE")"

# Load the elisp script silently (suppress the 't' return value)
if ! emacsclient -e "(load \"$SCRIPT_EL\")" > /dev/null 2>&1; then
    notify-send -u critical "Site Export" "Failed to load elisp. Is Emacs running?"
    echo "[$(date '+%H:%M:%S')] FATAL: Failed to load $SCRIPT_EL" >> "$LOG_FILE"
    exit 1
fi

# Notify start
notify-send -t 2000 "Site Export" "Exporting content..."

# Run the export function and capture result
RESULT=$(emacsclient -e '(xz/export-site-content)' 2>> "$LOG_FILE")

# Clean the result (remove elisp string quotes)
RESULT_CLEAN="${RESULT#\"}"
RESULT_CLEAN="${RESULT_CLEAN%\"}"

# Notify completion
if [[ "$RESULT_CLEAN" == *"Error"* ]] && [[ "$RESULT_CLEAN" != *"Errors: 0"* ]]; then
    notify-send -u critical -t 5000 "Site Export" "$RESULT_CLEAN"
else
    notify-send -t 4000 "Site Export âœ“" "$RESULT_CLEAN"
fi

