#+TITLE: System Manual Setup
#+AUTHOR: xynapz
#+DATE: 2026-02-03
#+STARTUP: overview
#+OPTIONS: toc:2

* Introduction

This document contains manual setup steps required for the NixOS system that
cannot be fully declarative. These are one-time operations or user-specific
configurations that need to be performed after a fresh install or when adding
new features.

* Initial System Setup

** First Boot

After installing NixOS and cloning the dotfiles repository:

#+begin_src bash
# Clone dotfiles
git clone https://github.com/xynapz/dotfiles ~/dotfiles
cd ~/dotfiles

# Build and activate the system
sudo nixos-rebuild switch --flake .#xynapz
#+end_src

** User Directories

The XDG user directories are created automatically by Home Manager, but you may
want to populate them:

#+begin_src bash
# Create wallpaper directory (required for wallpaper-selector.sh)
mkdir -p ~/Pictures/Wallpapers
mkdir -p ~/Pictures/Screenshots

# Create initial wallpaper symlink
ln -sf ~/Pictures/Wallpapers/default.jpg ~/.current-wallpaper
#+end_src

* Doom Emacs

Doom Emacs requires a manual installation step because it clones its own
repository and manages its own packages outside of Nix.

** Installation

#+begin_src bash
# Clone Doom Emacs
git clone --depth 1 https://github.com/doomemacs/doomemacs ~/.emacs.d

# Run the installer
~/.emacs.d/bin/doom install
#+end_src

The Doom configuration is already linked from =config/doom= via Home Manager.

** Maintenance

#+begin_src bash
# Sync packages after updating config/doom
doom sync

# Upgrade Doom itself
doom upgrade

# Rebuild all packages
doom build

# Run doctor to check for issues
doom doctor
#+end_src

** Troubleshooting

If Emacs daemon fails to start:

#+begin_src bash
# Kill existing daemon
pkill -f emacs

# Restart daemon
emacs --daemon

# Check daemon status
emacsclient -e "(emacs-version)"
#+end_src

* Tailscale (Secure Remote Access)

Tailscale creates a secure mesh VPN between your devices, allowing you to access
your personal wiki (and other services) from your phone regardless of location.
The declarative config is in =hosts/common/tailscale.nix=.

** Initial Authentication

After enabling Tailscale in NixOS config and rebuilding:

#+begin_src bash
# Authenticate (opens browser for login)
sudo tailscale up

# Verify connection and get your Tailscale IP
tailscale status
#+end_src

Note your laptop's Tailscale IP (looks like =100.x.y.z=). This IP is stable and
won't change unless you reinstall Tailscale.

** Android Setup

1. Install *Tailscale* from Google Play Store on your S25 Ultra
2. Log in with the same account you used on NixOS
3. Approve the device in your admin console if prompted: https://login.tailscale.com/admin/machines

** Accessing Services via Tailscale

Your personal wiki (Flask on port 5000) is accessible from your phone:

#+begin_src
http://100.x.y.z:5000
#+end_src

Replace =100.x.y.z= with your laptop's Tailscale IP from =tailscale status=.

Bookmark this URL on your phone for quick access.

** Daily Usage

#+begin_src bash
# Check connection status
tailscale status

# Get your Tailscale IP
tailscale ip -4

# See connected devices
tailscale status --active

# Disconnect temporarily
sudo tailscale down

# Reconnect
sudo tailscale up
#+end_src

** Troubleshooting

If connection fails:

#+begin_src bash
# Check Tailscale daemon status
systemctl status tailscaled

# View logs
journalctl -u tailscaled -n 50

# Re-authenticate if needed
sudo tailscale up --reset

# Check firewall
sudo iptables -L -n | grep tailscale
#+end_src

If Android can't connect:
- Ensure both devices are logged into the same Tailscale account
- Check that both devices appear in https://login.tailscale.com/admin/machines
- Try toggling Tailscale off/on on the Android app
- Verify the laptop is online: =tailscale ping <android-ip>=

* Waydroid (Android Container)

Waydroid runs Android apps natively on Wayland. The declarative config is in
=hosts/common/waydroid.nix=, but the Android image download is imperative.

** Initial Setup

After enabling Waydroid in NixOS config and rebuilding:

#+begin_src bash
# Initialize Waydroid with Google Apps (for Play Store)
sudo waydroid init -s GAPPS -f

# Start the container service
sudo systemctl start waydroid-container

# Launch Android UI
waydroid show-full-ui
#+end_src

** Daily Usage

#+begin_src bash
# Launch full Android UI
waydroid show-full-ui

# List installed apps
waydroid app list

# Launch specific app
waydroid app launch <app_name>

# Install APK file
waydroid app install /path/to/app.apk
#+end_src

** Maintenance

#+begin_src bash
# Update Android system
sudo waydroid upgrade

# Stop current session
waydroid session stop

# Restart container
sudo systemctl restart waydroid-container
#+end_src

** Reset Waydroid

Complete reinstall if something breaks:

#+begin_src bash
# Stop everything
waydroid session stop
sudo systemctl stop waydroid-container

# Remove all Waydroid data
sudo rm -rf /var/lib/waydroid
sudo rm -rf ~/.local/share/waydroid

# Reinitialize
sudo waydroid init -s GAPPS -f
#+end_src

* Online Accounts (Google, Microsoft, etc.)

GNOME Online Accounts provides OAuth integration with cloud services. The
declarative config is in =hosts/common/online-accounts.nix=. Credentials are
stored encrypted in gnome-keyring, which auto-unlocks on login.

** Adding an Account

Since we are on Sway (not full GNOME), launch gnome-control-center explicitly:

#+begin_src bash
XDG_CURRENT_DESKTOP=GNOME gnome-control-center
#+end_src

Then:
1. Navigate to "Online Accounts"
2. Click "Add Account"
3. Select your provider (Google, Microsoft, etc.)
4. Complete the OAuth flow in the browser

** Supported Services

After adding a Google account:
- Calendar syncs to GNOME Calendar
- Contacts sync to GNOME Contacts
- Google Drive appears in Nautilus sidebar
- Files accessible via GVFS

** Keyring Management

Use Seahorse to manage stored credentials:

#+begin_src bash
seahorse
#+end_src

The keyring auto-unlocks on SDDM login via PAM integration.

** Troubleshooting

If accounts fail to authenticate:

#+begin_src bash
# Check GOA daemon
systemctl --user status goa-daemon

# Check keyring daemon
systemctl --user status gnome-keyring-daemon

# Restart services
systemctl --user restart goa-daemon
systemctl --user restart gnome-keyring-daemon
#+end_src

If the keyring is locked:

#+begin_src bash
# Unlock manually
seahorse
# Right-click "Login" keyring and unlock
#+end_src

* Git Configuration

** SSH Keys

Generate SSH keys for GitHub:

#+begin_src bash
# Generate new SSH key
ssh-keygen -t ed25519 -C "xynapz@aol.com"

# Start ssh-agent
eval "$(ssh-agent -s)"

# Add key to agent
ssh-add ~/.ssh/id_ed25519

# Copy public key to clipboard
wl-copy < ~/.ssh/id_ed25519.pub
#+end_src

Then add the public key to GitHub at https://github.com/settings/keys

** GitHub CLI

#+begin_src bash
# Login to GitHub
gh auth login

# Follow the prompts and select SSH
#+end_src

* Wallpaper System

The wallpaper system uses a symlink at =~/.current-wallpaper= that points to the
active wallpaper. This is used by Sway and Swaylock.

** Setup

#+begin_src bash
# Create wallpaper directory
mkdir -p ~/Pictures/Wallpapers

# Add wallpapers to the directory
cp /path/to/wallpapers/* ~/Pictures/Wallpapers/

# Set initial wallpaper
ln -sf ~/Pictures/Wallpapers/your-wallpaper.jpg ~/.current-wallpaper
#+end_src

** Usage

Use =Mod+Shift+w= to open the wallpaper selector, which will:
- Show all wallpapers in =~/Pictures/Wallpapers=
- Update the =~/.current-wallpaper= symlink
- Apply the wallpaper to all outputs

* Bluetooth

** Pairing Devices

#+begin_src bash
bluetoothctl
#+end_src

Inside bluetoothctl:

#+begin_example
power on
scan on
# Wait for device to appear, note the MAC address
pair <MAC_ADDRESS>
trust <MAC_ADDRESS>
connect <MAC_ADDRESS>
exit
#+end_example

** Auto-connect

Trusted devices will auto-connect on boot.

* NixOS System Management

** Rebuild Commands

#+begin_src bash
# Switch to new configuration
sudo nixos-rebuild switch --flake ~/dotfiles#xynapz

# Build but don't activate (next boot)
sudo nixos-rebuild boot --flake ~/dotfiles#xynapz

# Test without adding boot entry
sudo nixos-rebuild test --flake ~/dotfiles#xynapz

# List generations
sudo nix-env --list-generations --profile /nix/var/nix/profiles/system

# Rollback to previous generation
sudo nixos-rebuild switch --rollback
#+end_src

** Flake Updates

#+begin_src bash
# Update all inputs
nix flake update

# Update specific input
nix flake lock --update-input nixpkgs

# Rebuild after update
sudo nixos-rebuild switch --flake ~/dotfiles#xynapz
#+end_src

** Garbage Collection

#+begin_src bash
# Automatic weekly cleanup is configured
# Manual cleanup:
sudo nix-collect-garbage -d

# Remove old boot entries
sudo nix-collect-garbage --delete-older-than 7d
sudo nixos-rebuild boot --flake ~/dotfiles#xynapz
#+end_src

* Development Environments

** Rust

#+begin_src bash
# Install stable toolchain
rustup default stable

# Install nightly
rustup toolchain install nightly

# Update toolchains
rustup update
#+end_src

** Python Virtual Environments

#+begin_src bash
# Create venv
python -m venv .venv

# Activate (or use 'penv' alias)
source .venv/bin/activate

# Deactivate
deactivate
#+end_src

** Node.js

Node.js is installed globally via Home Manager. For project-specific versions,
use direnv with a =.envrc= file:

#+begin_src bash
# In project directory
echo "use node 20" > .envrc
direnv allow
#+end_src

* Display Configuration

** Monitor Setup

The monitor configuration is in =home/modules/sway.nix=. If you change monitors:

#+begin_src bash
# List available outputs
swaymsg -t get_outputs

# Get detailed info
swaymsg -t get_outputs | jq
#+end_src

Update the output section in =sway.nix= with the correct names and resolutions.

** Refresh Rate

To change refresh rate:

#+begin_src nix
output."HDMI-A-1" = {
  resolution = "2560x1440@144Hz";  # Change Hz value
  position = "0,0";
};
#+end_src

* Audio

PipeWire is configured declaratively. No manual setup required.

** Troubleshooting

#+begin_src bash
# Restart PipeWire
systemctl --user restart pipewire pipewire-pulse wireplumber

# Check status
systemctl --user status pipewire

# List audio devices
pactl list sinks short
pactl list sources short
#+end_src

* GPU Information

** Check GPU Status

#+begin_src bash
# List GPUs
lspci | grep -i vga

# Check Vulkan support (useful for Waydroid)
vulkaninfo | head -20

# OpenGL info
glxinfo | grep "OpenGL"
#+end_src

* Fonts

Fonts are installed declaratively. To verify:

#+begin_src bash
# List available fonts
fc-list | grep -i iosevka

# Rebuild font cache
fc-cache -fv
#+end_src

* Troubleshooting

** Sway Won't Start

#+begin_src bash
# Check Sway config syntax
sway --validate

# Start Sway from TTY with debug output
sway --debug 2> ~/sway.log
#+end_src

** Home Manager Issues

#+begin_src bash
# Check Home Manager status
home-manager generations

# Rollback Home Manager
home-manager generations | head -2
/nix/store/<hash>-home-manager-generation/activate
#+end_src

** SDDM Login Issues

#+begin_src bash
# Check SDDM logs
journalctl -u display-manager -b

# Restart SDDM
sudo systemctl restart display-manager
#+end_src
